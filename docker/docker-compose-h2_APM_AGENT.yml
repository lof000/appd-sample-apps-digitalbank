###################################
### DIGITAL BANKING 
# app
# no backends
# app agents
#
# Please configure APM related info in .env file
###################################

version: "3.5"
services:

# APM - MONTAR O VOLUME DO AGENTE
  caapm-agent-saas:
    image: leandrobroadcom/docker-apm-agent:20.11
    container_name: caapm-agent
    volumes:
      - agent-volume:/opt/caapm/agent

###################################
### DIGITAL BANKING APP - BEGIN
###################################

# =====================================================================
# Digital Broker Service Configuration
# =====================================================================
  broker:
    image: leandrobroadcom/digitalbroker-new:1.0
    container_name: broker
    hostname: broker
    ports:
      - "8161:8161"
      - "61616:61616"
    restart: unless-stopped

# =====================================================================
# Digital Credit Service Configuration
# =====================================================================    
  credit:
    image: leandrobroadcom/digitalcredit-new:1.0
    container_name: credit
    hostname: credit
    environment:

      # Debug Options
      LOGGING_LEVEL_IO_DIGISIC_CREDIT: INFO

      # Digital Broker Connection
      SPRING_ARTEMIS_MODE: native
      SPRING_ARTEMIS_HOST: broker
      SPRING_ARTEMIS_PORT: 61616
      SPRING_ARTEMIS_USER: admin
      SPRING_ARTEMIS_PASSWORD: admin

      # Credit Application Process
      IO_DIGISIC_CREDIT_APP_PROCESS_ENABLED: 'true'
      IO_DIGISIC_CREDIT_APP_PROCESS_TIME: 20

      # Digital Credit Application Process JMS Queues
      IO_DIGISIC_PARTNER_CREDIT_APP_REQUEST: CREDIT.APP.REQUEST
      IO_DIGISIC_PARTNER_CREDIT_APP_RESPONSE: CREDIT.APP.RESPONSE

      # APM AGENT VARIABLES
      APMENV_AGENTNAME: "digitalbank_credit"
      APMENV_INTROSCOPE_AGENT_HOSTNAME: "${CREDIT_HOST}"
      JAVA_OPTS: -javaagent:/opt/caapm/agent/wily/Agent.jar
      APMENV_INTROSCOPE_AGENT_BROWSERAGENT_AUTOINJECTIONENABLED: "false"
      APMENV_AGENTMANAGER_CREDENTIAL: "${AGENT_CREDENTIAL}"

    ports:
      - "3500:8080"

    depends_on:
      - broker

    #APM - ADD AGENT VOLUME
    volumes:
      - agent-volume:/opt/caapm/agent      

    restart: unless-stopped

# =====================================================================
# Digital Bank Service Configuration
# =====================================================================
  bank:
    image: leandrobroadcom/digitalbank-new:1.0
    container_name: bank
    hostname: bank
    environment:

      # Debug Options
      LOGGING_LEVEL_IO_DIGISIC_BANK: INFO
      
      # Digital Broker connection
      SPRING_ARTEMIS_MODE: native
      SPRING_ARTEMIS_HOST: broker
      SPRING_ARTEMIS_PORT: 61616
      SPRING_ARTEMIS_USER: admin
      SPRING_ARTEMIS_PASSWORD: admin

      # Digital Credit Connection
      IO_DIGISIC_CREDIT_ENABLED: 'true'
      IO_DIGISIC_CREDIT_PROTOCOL: http
      IO_DIGISIC_CREDIT_HOST: credit
      IO_DIGISIC_CREDIT_PORT: 8080
      IO_DIGISIC_CREDIT_CONTEXT-PATH: /credit
      IO_DIGISIC_CREDIT_USERNAME: admin@demo.io
      IO_DIGISIC_CREDIT_PASSWORD: Demo123!

      # Digital Credit Application Process JMS Queues
      IO_DIGISIC_PARTNER_CREDIT_APP_REQUEST: CREDIT.APP.REQUEST
      IO_DIGISIC_PARTNER_CREDIT_APP_RESPONSE: CREDIT.APP.RESPONSE

      # ATM Location Service Connection 
      IO_DIGISIC_BANK_ATM_PROTOCOL: http
      IO_DIGISIC_BANK_ATM_HOST: api-gateway # uat-api.synapsefi.com #
      IO_DIGISIC_BANK_ATM_PORT: 8080

      # VISA Direct Payment Service
      IO_DIGISIC_BANK_VISA_PROTOCOL: http
      IO_DIGISIC_BANK_VISA_HOST: api-gateway
      IO_DIGISIC_BANK_VISA_PORT: 8080
      
      # Open Banking API Service
      IO_DIGISIC_BANK_OBP_ENABLED: 'true'
      IO_DIGISIC_BANK_OBP_CONSUMER_KEY: vwfpvwfr1kngt0up2jelebzmvxrhst4vhxvw1jm3
      IO_DIGISIC_BANK_OBP_VERSION: v4.0.0
      IO_DIGISIC_BANK_OBP_PROTOCOL: https
      IO_DIGISIC_BANK_OBP_HOST:
      IO_DIGISIC_BANK_OBP_PORT:

      #APM AGENT VARIABLES
      APMENV_AGENTNAME: "digitalbank_front"
      APMENV_INTROSCOPE_AGENT_HOSTNAME: "${BANK_HOST}"
      JAVA_OPTS: -javaagent:/opt/caapm/agent/wily/Agent.jar
      APMENV_AGENTMANAGER_CREDENTIAL: "${AGENT_CREDENTIAL}"
      APMENV_INTROSCOPE_AGENT_BROWSERAGENT_AUTOINJECTIONENABLED: "true"
      APMENV_INTROSCOPE_AGENT_BROWSERAGENT_CONTENTENCODING_ENABLED: "true"
      APMENV_INTROSCOPE_AGENT_BROWSERAGENT_INSTRUMENTCLASS_AUTOSKIP_DEPTH: "5"
      APMENV_INTROSCOPE_AGENT_BROWSERAGENT_AUTOINJECTION_DEEP_CHECK: "true"
      APMENV_INTROSCOPE_AGENT_BROWSERAGENT_SNIPPETSTRING: '${BROWSER_AGENT_SNIPPET}'
#      APMENV_LOG4J_LOGGER_INTROSCOPEAGENT: "INFO, logfile"
#      APMENV_LOG4J_LOGGER_INTROSCOPEAGENT_BROWSERAGENT: "TRACE#com.wily.util.feedback.Log4JSeverityLevel, logfile"

    ports:
      - "8080:8080"

    depends_on:
      - broker
      - credit

    #APM - ADD AGENT VOLUME
    volumes:
      - agent-volume:/opt/caapm/agent
    restart: unless-stopped      

###################################
### DIGITAL BANKING APP - END
###################################  


#APM ADD AGENT VOLUME
volumes:
  agent-volume:
